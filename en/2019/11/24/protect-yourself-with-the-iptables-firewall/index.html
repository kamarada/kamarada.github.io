<!DOCTYPE html>
<html lang="en" prefix="
    addthis: http://www.addthis.com/help/api-spec
    og: http://ogp.me/ns#
    fb: http://ogp.me/ns/fb#
    article: http://ogp.me/ns/article#">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    
        <script type="text/javascript">
            if (("kamarada.github.io" == window.location.host) && (window.location.protocol != "https:")) {
                window.location = window.location.toString().replace(/^http:/, "https:");
            }
        </script>
    

    <title>
        
            
                Protect yourself with the iptables firewall - Linux Kamarada
            
        
    </title>
    <meta name="author" content="Antônio Vinícius">
    <meta name="description" content="We haven’t talked about servers for a while… Today we are going to talk about security thinking on servers first, but on desktops too, either at home or at w...">
    <link rel="canonical" href="https://kamarada.github.io/en/2019/11/24/protect-yourself-with-the-iptables-firewall/">
    <link rel="alternate" type="application/rss+xml" title="Linux Kamarada" href="https://kamarada.github.io/en/feed.xml" />

    
    
        
    
        
            <link rel="alternate" hreflang="pt" href="https://kamarada.github.io/pt/2019/11/18/proteja-se-com-o-firewall-iptables/" />
        
    

    <!-- OpenSearch -->
    <link rel="search" type="application/opensearchdescription+xml" title="Search Linux Kamarada" href="https://kamarada.github.io/en/opensearch.xml" />

    <!-- Open Graph -->
    
        <meta property="article:published_time" content="2019-11-24 15:50:00 -0300"/>
        
            <meta property="article:publisher" content="https://facebook.com/LinuxKamarada" />
        
    
    
        <meta property="fb:app_id" content="2998145206923971" />
    
    
        <meta property="fb:page_id" content="1700979763454346" />
    
    <meta property="og:description" content="We haven’t talked about servers for a while… Today we are going to talk about security thinking on servers first, but on desktops too, either at home or at w..." />
    
        <meta property="og:image" content="https://kamarada.github.io/files/2019/11/iptables.jpg" />
    
    <meta property="og:site_name" content="Linux Kamarada" />
    <meta property="og:title" content="Protect yourself with the iptables firewall" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://kamarada.github.io/en/2019/11/24/protect-yourself-with-the-iptables-firewall/" />

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@LinuxKamaradaWW" />
    

    <!-- Favicons (made with RealFaviconGenerator.net) -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://kamarada.github.io/apple-touch-icon.png?v=4">
    <link rel="icon" type="image/png" sizes="32x32" href="https://kamarada.github.io/favicon-32x32.png?v=4">
    <link rel="icon" type="image/png" sizes="16x16" href="https://kamarada.github.io/favicon-16x16.png?v=4">
    <link rel="manifest" href="https://kamarada.github.io/site.webmanifest?v=4">
    <link rel="shortcut icon" href="https://kamarada.github.io/favicon.ico?v=4">
    <meta name="msapplication-TileColor" content="#4caf50">
    <meta name="theme-color" content="#4caf50">

    <!-- CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons">
    
        <!--<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">-->
        <!--<link rel="stylesheet" href="https://unpkg.com/bootstrap-material-design@4.1.2/dist/css/bootstrap-material-design.min.css" integrity="sha384-dI6l3oYG+wVvjfdlixt6+FMddrb9+uejLU/wMhQFKklk7RDtSDBfe/XuF1dkcgVV" crossorigin="anonymous">-->
        <link rel="stylesheet" href="/libs/bootstrap-material-design/4.1.2/custom/bootstrap-material-design.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous">
    
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- JS -->
    
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha256-x3YZWtRjM8bJqf48dFAv/qmgL68SI4jqNWeSLMZaMGA=" crossorigin="anonymous"></script>
        <!--<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>-->
        <script src="https://unpkg.com/bootstrap-material-design@4.1.2/dist/js/bootstrap-material-design.min.js" integrity="sha384-aWO+CcMRDQLEvnT8RdnCxWbs4C76Ryoo4pzYpGNW2vlHTHiPA7gpBzIB5nYwYfLg" crossorigin="anonymous"></script>
    
    <script src="/assets/js/main.js"></script>

    
        <!-- Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-65333685-3"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'UA-65333685-3');
        </script>
        <!-- End Google Analytics -->
    

    
        <!-- Google AdSense -->
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    

    
        
            <!-- AddThis -->
            <script async src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-563f92aa117815bd"></script>
            <script type="text/javascript">
                var addthis_config = {
                    data_track_clickback: true,
                    data_track_addressbar: true,
                    
                        ui_language: 'en'
                    
                };
                var addthis_share = {
                    url: 'https://kamarada.github.io/en/2019/11/24/protect-yourself-with-the-iptables-firewall/',
                    title: document.title,
                    description: 'We haven’t talked about servers for a while… Today we are going to talk about security thinking on servers first, but on desktops too, either at home or at w...'
                };
            </script>
            <!-- End AddThis -->
        
    
</head>


<body itemscope itemtype="http://schema.org/BlogPosting">
    
        <!-- Facebook SDK -->
        <div id="fb-root"></div>
        <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v4.0&appId=&autoLogAppEvents=1"></script>
        <!-- End Facebook SDK -->
    

    <div class="bmd-layout-container bmd-drawer-f-l bmd-drawer-overlay">
        <!-- Fixed navbar -->
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-primary">
    <div class="container">
        <button type="button" class="navbar-toggler" data-toggle="drawer" data-target="#drawer">
            <span class="sr-only">
                
                    Toggle drawer
                
            </span>
            <i class="material-icons">menu</i>
        </button>

        <a class="navbar-brand" href="/">
            
                Linux Kamarada
            
        </a>

        <div class="collapse navbar-collapse" id="navbar">
            <ul class="navbar-nav m-auto">
                

                
                    
                        <li class="nav-item">
                            <a class="nav-link" href="/en/download">Download</a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="nav-link" href="/en/help">Help</a>
                        </li>
                    
                
            </ul>
            <form action="/en/search/" class="form-inline search-form" id="navbar-search-form" method="get" role="search">
                
                
                <div class="input-group">
                    <input class="form-control search-field" id="navbar-search-field" name="q" placeholder="Search" type="text" aria-label="Search">
                    <div class="input-group-append">
                        <button class="btn btn-secondary btn-number search-button" id="navbar-search-button" type="submit">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="dropdown">
                    <a class="dropdown-toggle" id="navbar-language-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Translations" href="#" role="button"><i class="fas fa-globe-americas" aria-hidden="true"></i></a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbar-language-button">
                        
                        
                            <h6 class="dropdown-header">English</h6>
                            
                            
                                <a class="dropdown-item translation-en" href="https://kamarada.github.io/en/2019/11/24/protect-yourself-with-the-iptables-firewall/">This page in English</a>
                            
                            <a class="dropdown-item" href="https://kamarada.github.io/en/">English home page</a>
                            <div class="dropdown-divider"></div>
                        
                            <h6 class="dropdown-header">Português</h6>
                            
                            
                                <a class="dropdown-item translation-pt" href="https://kamarada.github.io/pt/2019/11/18/proteja-se-com-o-firewall-iptables/">Esta página em Português</a>
                            
                            <a class="dropdown-item" href="https://kamarada.github.io/pt/">Página inicial em Português</a>
                            <div class="dropdown-divider"></div>
                        
                        <h6 class="dropdown-header">Other languages (by Google Translate)</h6>
                        <a class="dropdown-item" href="http://translate.google.com/translate?js=n&sl=en&u=https://kamarada.github.io/en/2019/11/24/protect-yourself-with-the-iptables-firewall/">Translate this page</a>
                    </div>
                </div><!--.dropdown-->
            </form>
        </div><!--#navbar-->
    </div><!--.container-->
</nav>

        <!-- Navigation drawer -->
<div id="drawer" class="bmd-layout-drawer bg-faded">
    <header>
        <a class="navbar-brand" href="/">
            
                Linux Kamarada
            
        </a>
    </header>
    <form action="/en/search/" class="form-inline border-top" id="drawer-search-form" method="get" role="search">
        
        
        <div class="bmd-form-group-sm">
            <div class="input-group">
                <input class="form-control search-field" id="drawer-search-field" name="q" placeholder="Search" type="text" aria-label="Search">
                <div class="input-group-append">
                    <button class="btn btn-secondary btn-number search-button" id="drawer-search-button" type="submit">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
            </div><!-- .input-group -->
        </div><!-- .bmd-form-group-sm -->
    </form>
    <ul class="list-group list-group-flush border-top" id="drawer-links">
        

        
            
                <li class="nav-item">
                    <a class="nav-link" href="/en/download">Download</a>
                </li>
            
                <li class="nav-item">
                    <a class="nav-link" href="/en/help">Help</a>
                </li>
            
        
    </ul>

    <div class="btn-group mb-3 mt-3">
        <button type="button" class="btn btn-secondary" id="drawer-language-button">
            <i class="fas fa-globe-americas" aria-hidden="true"></i> English
        </button>
    </div>
</div><!--.drawer-->


        <main class="bmd-layout-content">
            <div class="container" id="main-container">
                <div class="row">
                    <div class='col-sm-8'>
                        <!--<div class='gap-small'>
                            <a href='http://en.opensuse.org/Portal:15.1'>
                                <img class='img-fluid' id='countdown' src='http://countdown.opensuse.org/wide.png'/>
                            </a>
                        </div>-->
                        <div class="blog-post card mb-3">
    <header class="card-header">
        <h1 class="blog-post-title" itemprop="headline name">
            <a class="blog-post-link" href="/en/2019/11/24/protect-yourself-with-the-iptables-firewall/" itemprop="mainEntityOfPage url">
                Protect yourself with the iptables firewall
            </a>
        </h1>
        <div class="blog-post-meta row">
            <div class='col-sm-6'>
                <p class="blog-post-date" itemprop="datePublished" content="2019-11-24">
                    <a href="/2019/11/24/">
                        
    Nov 24, 2019


                    </a>
                </p>
                <meta itemprop="dateModified" content="2019-11-24" />
            </div>
            <div class='col-sm-6'>
                
                    <div class='blog-post-share'>
                        <!-- AddThis Sharing Buttons -->
                        <div class="addthis_toolbox addthis_default_style">
                            <a class="addthis_button_facebook"></a>
                            <a class="addthis_button_twitter" data-via="LinuxKamaradaWW"></a>
                            <a class="addthis_button_telegram"></a>
                            <a class="addthis_button_favorites"></a>
                            <a class="addthis_button_compact"></a>
                            <a class="addthis_counter addthis_bubble_style"></a>
                        </div>
                        <!-- AddThis Sharing Buttons End -->
                    </div><!-- .blog-post-share -->
                
            </div><!-- .col-sm-6 -->
        </div><!-- .blog-post-meta -->
    </header>

    <article class="blog-post-content card-body">
        
            
    <!-- Google AdSense -->
    <ins class="adsbygoogle" id="content_ad_unit_1"
        style="display:block"
        data-ad-client="ca-pub-5193467168351289"
        data-ad-slot="8945658251"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    <!-- End Google AdSense -->


        

        <div itemprop="articleBody mainEntity">
            <p>We haven’t talked about servers for a while… Today we are going to talk about <strong>security</strong> thinking on servers first, but on desktops too, either at home or at work. The Internet has made it much easier to access, send and share information. But together with the pros, come the cons: besides convenience, the Internet also brought a lot of risks and threats. A security solution that can be employed to prevent attacks and intrusions is the firewall.</p>

<p>A <strong>firewall</strong> is a software that monitors incoming and outgoing network packets and allows or blocks specific packets based on predefined security rules.</p>

<div class="image no-ads-here text-center mb-3" itemscope="" itemtype="http://schema.org/ImageObject">
<a href="/files/2019/11/iptables.jpg" title="">
<img src="/files/2019/11/iptables.jpg" alt="" class="img-fluid img-thumbnail" itemprop="contentUrl" />
</a>

</div>

<p>If analogies help you understand concepts, think of a firewall as a party security that checks people’s IDs and allows them to enter the party only if they are on the guest list.</p>

<p>Actually, there are also hardware-based firewalls, or mixed hardware and software solutions, but usually a firewall is a software installed on a server or desktop.</p>

<p>Depending on where a firewall is positioned, it can assume different roles. It can be installed:</p>

<ul>
  <li>on any server (e.g. a web server) or desktop (e.g. a workstation) to protect the server or desktop itself;</li>
  <li>on a server positioned between the local network and the Internet, to protect the local network; or</li>
  <li>on a server that acts as a router among multiple internal networks, to protect them.</li>
</ul>

<div class="image no-ads-here text-center mb-3" itemscope="" itemtype="http://schema.org/ImageObject">
<a href="/files/2019/11/firewall-places.jpg" title="">
<img src="/files/2019/11/firewall-places.jpg" alt="" class="img-fluid img-thumbnail" itemprop="contentUrl" />
</a>

</div>

<p>According to the layer of the <a href="https://en.wikipedia.org/wiki/Internet_protocol_suite">TCP/IP model</a> in which they operate, firewalls can be classified into:</p>

<ul>
  <li><strong>packet filters:</strong> act on the layers 2 (network) and 3 (transport) and are capable of filtering packets by source/destination address/port/interface, protocol (whether it is TCP, UDP, ICMP, etc). Packet filters date back to the first known firewalls. They are the simpler and more limited type of firewall, but already offer a significant level of security.</li>
  <li><strong>application firewalls</strong>, better known as <strong><a href="https://en.wikipedia.org/wiki/Proxy_server">proxies</a></strong>: act on the layer 4 (application) and are capable of filtering packets based on their content. For instance, an HTTP proxy can block access to a page if there is a particular word in the URL, or if the requested website is known for piracy, gambling, pornography, malware, etc.</li>
</ul>

<h2 id="how-is-the-firewall-on-linux">How is the firewall on Linux?</h2>

<p>The <a href="https://www.kernel.org/">Linux kernel</a> comes with a built-in firewall, which is the <code class="highlighter-rouge">ip_tables</code> module. To manage it, we use the <strong><a href="https://netfilter.org/projects/iptables/">iptables</a></strong> command line tool.</p>

<p>Usually, people make things simpler and refer to both the kernel module and the command line tool as <strong>iptables</strong>, as if they were the same thing. Let’s do the same here.</p>

<p><strong>iptables</strong> is primarily a packet filter, but it has modules that extend its functionality and allow it to act on the application layer. It comes pre-installed by default on most Linux distributions, including <a href="/en/2019/09/13/first-beta-release-of-the-kamarada-linux-distribution/">Linux Kamarada</a> and <a href="https://www.opensuse.org/">openSUSE</a>. That means we can just start using <strong>iptables</strong>: we don’t need to install anything before.</p>

<p>The original <code class="highlighter-rouge">ip_tables</code> module and <strong>iptables</strong> tool only handle IPv4. There are also <code class="highlighter-rouge">ip6_tables</code> and <strong>ip6tables</strong> for dealing with IPv6.</p>

<p>Many distributions provide alternative tools for managing the kernel built-in firewall. <strong><a href="https://firewalld.org/">firewalld</a></strong> is a notable one and can be used from both the command line and the graphical user interface (which some people may find it easier to use). By default, new openSUSE installations come with <strong>iptables</strong> and <strong>firewalld</strong> on desktops, but only with <strong>iptables</strong> (without <strong>firewalld</strong>) on servers. Linux Kamarada, which is intended for desktops and beginner Linux users, also comes out-of-the-box with <strong>iptables</strong> and <strong>firewalld</strong>.</p>

<p>Today, we are going to focus on <strong>iptables</strong>. Perhaps another time we can talk about <strong>firewalld</strong>. We already mentioned it in another post. So, if you want to get an idea of what it looks like, see:</p>

<ul>
  <li><a href="/en/2019/04/01/streaming-from-linux-to-tv-using-chromecast/">Streaming from Linux to TV using Chromecast</a></li>
</ul>

<h2 id="basic-concepts">Basic concepts</h2>

<p>To understand how <strong>iptables</strong> works, you need to know what are: rules, chains, tables, targets, and default policy.</p>

<p>A firewall <strong>rule</strong> specifies criteria for a packet (source/destination address/port/interface, protocol, etc.) and what to do with a packet that matches (such as block or allow).</p>

<p>A <strong>chain</strong> is a list of rules. <strong>iptables</strong> has its predefined chains and the user can also create their own chains.</p>

<p><strong>Tables</strong> are sets of chains. <strong>iptables</strong> has four tables that are used at different times, detailed below: <code class="highlighter-rouge">filter</code>, <code class="highlighter-rouge">nat</code>, <code class="highlighter-rouge">mangle</code> and <code class="highlighter-rouge">raw</code>. Each table contains a number of built-in chains and may also contain user-defined chains. Today let’s focus on the <code class="highlighter-rouge">filter</code> table. Another time we can talk about the other ones.</p>

<ul>
  <li><code class="highlighter-rouge">filter</code>: this is the default table, it contains 3 built-in chains:
    <ul>
      <li><code class="highlighter-rouge">INPUT</code>: queried when packets arrive at the machine</li>
      <li><code class="highlighter-rouge">OUTPUT</code>: queried when packets should leave the machine</li>
      <li><code class="highlighter-rouge">FORWARD</code>: queried when packets are to be routed through the machine (forwarded from one network interface to another, or from one machine to another through the current machine)</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">nat</code>: this table is used to do <a href="https://en.wikipedia.org/wiki/Network_address_translation">NAT</a> (Network Address Translation), it contains 3 built-in chains: <code class="highlighter-rouge">PREROUTING</code>, <code class="highlighter-rouge">OUTPUT</code> and <code class="highlighter-rouge">POSTROUTING</code></li>
  <li><code class="highlighter-rouge">mangle</code>: this table is used for specialized packet alteration, such as modifying the type of service (<a href="https://en.wikipedia.org/wiki/Type_of_service">ToS</a>) field, it contains 5 built-in chains: <code class="highlighter-rouge">PREROUTING</code>, <code class="highlighter-rouge">OUTPUT</code>, <code class="highlighter-rouge">INPUT</code>, <code class="highlighter-rouge">FORWARD</code> and <code class="highlighter-rouge">POSTROUTING</code></li>
  <li><code class="highlighter-rouge">raw</code>: this table is queried by <strong>iptables</strong> before the others and is used mainly for configuring exemptions from connection tracking, it contains 2 built-in chains: <code class="highlighter-rouge">PREROUTING</code> and <code class="highlighter-rouge">OUTPUT</code>.</li>
</ul>

<p>Note that chain names are case sensitive (e.g. <code class="highlighter-rouge">INPUT</code>, <code class="highlighter-rouge">input</code> and <code class="highlighter-rouge">Input</code> would be 3 different chains). Built-in chains names are always written in uppercase (e.g. <code class="highlighter-rouge">INPUT</code>).</p>

<p>When <strong>iptables</strong> receives a packet, it looks for a rule that describes that packet. Rules are examined in the order they were added to the chain. If the packet does not match the current rule, the next one in the chain is examined. If the packet does match, then <strong>iptables</strong> does what the rule says to do with the packet, which is called the <strong>target</strong>.</p>

<p>The target can be the name of a user-defined chain — in which case <strong>iptables</strong> continues processing the rules of that chain — or one of the following special values, which cause <strong>iptables</strong> to stop processing the current chain rules and take immediate action on the packet:</p>

<ul>
  <li><code class="highlighter-rouge">ACCEPT</code>: let the packet through</li>
  <li><code class="highlighter-rouge">DROP</code>: discard (delete, ignore) the packet — in practice, it means to block the packet</li>
  <li><code class="highlighter-rouge">QUEUE</code>: pass the packet to a userspace process (outside the kernel) that will process the packet</li>
  <li><code class="highlighter-rouge">RETURN</code>: stop traversing the current chain and resume at the next rule in the previous (calling) chain</li>
</ul>

<p>Finally, if <strong>iptables</strong> reaches the end of a built-in chain and no rule that matches the packet was found, the target specified by the <strong>default policy</strong> of the chain determines the fate of the packet. Only one of those four special targets can be set as default policy for a built-in chain.</p>

<p>There is also the <code class="highlighter-rouge">REJECT</code> target, which is similar to <code class="highlighter-rouge">DROP</code>, but can be used only in <code class="highlighter-rouge">filter</code> chains rules. More about the <code class="highlighter-rouge">REJECT</code> target later.</p>

<p>Does all of that sound confusing to you? Don’t worry: let’s get our hands dirty and everything will become clearer.</p>

<h2 id="listing-current-rules">Listing current rules</h2>

<p>We haven’t added any rules yet, but does our firewall have any rules already? Let’s see!</p>

<p>To list the rules currently in use by <strong>iptables</strong>, run the following command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -L
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Today we are going to use only the command line interface and almost all commands will be run with administrator privileges (i.e. as root). I suppose you already have some familiarity with Linux and the <a href="http://opensuse-guide.org/command.php">terminal</a>.</p>

<p>The output of the above command should look something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is the default <strong>iptables</strong> setup: all chains have a default policy of <code class="highlighter-rouge">ACCEPT</code> and no rules beforehand, which means that all incoming and outgoing traffic is allowed.</p>

<p>If that output is different for you, maybe the system administrator has already added rules, the Linux distribution you use has another default setting, or you are using <strong>firewalld</strong>, which creates its own chains. Next we are going to see how to delete these rules.</p>

<p>The <code class="highlighter-rouge">filter</code> table is considered by default if no table is specified. To list rules of another table, add the <code class="highlighter-rouge">-t</code> parameter (or <code class="highlighter-rouge">--table</code>) followed by the table name. For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre># iptables -t nat -L
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Also, if no chain is selected, all chains are listed. To list rules of a specific chain only, add its name to the end of the command. For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre># iptables -t mangle -L FORWARD
Chain FORWARD (policy ACCEPT)
target     prot opt source               destination
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="deleting-all-current-rules">Deleting all current rules</h2>

<p>Keep in mind that the order of your rules matters. So, it’s common to start setting up <strong>iptables</strong> by deleting any rules currently in use.</p>

<div class="alert alert-danger" role="alert">

<p><strong>Do not</strong> try running the commands in this tutorial on a remote server that you access via SSH: you will risk losing access to the server.</p>

</div>

<div class="alert alert-info" role="alert">

<p>To follow this tutorial, I recommend that you use a virtual machine. Doing that, you don’t modify your server or desktop firewall settings.</p>

<p>For more information, read:</p>

<ul>
  <li><a href="/en/2019/10/10/virtualbox-the-easiest-way-to-try-linux-without-installing-it/">VirtualBox: the easiest way to try Linux without installing it</a></li>
</ul>

</div>

<p>To delete all the rules currently in use, run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -F
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Actually by default all the chains in the <code class="highlighter-rouge">filter</code> table are flushed if no table or chain are given.</p>

<p>In that sense, the <code class="highlighter-rouge">iptables -F</code> command is similar to the <code class="highlighter-rouge">iptables -L</code> command:</p>

<ul>
  <li>to flush chains of another table, add the <code class="highlighter-rouge">-t</code> parameter followed by the table name, and</li>
  <li>to flush only a specific chain, add its name to the end of the command.</li>
</ul>

<p>Examples:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre># iptables -t nat -F
# iptables -t mangle -F POSTROUTING

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="deleting-all-user-defined-chains">Deleting all user-defined chains</h2>

<p>Besides deleting rules, it’s also common to start deleting any user-defined chains.</p>

<p>To delete all user-defined chains in the <code class="highlighter-rouge">filter</code> table, run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -X
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Even if you haven’t created any chains yourself, if <strong>firewalld</strong> is running, that command deletes chains created by <strong>firewalld</strong>.</p>

<p>Similarly to previous commands, to specify a table, use the <code class="highlighter-rouge">-t</code> parameter, and to delete only a specific chain, add its name to the end of the command.</p>

<p>Note that it’s not possible to delete built-in chains, only user-defined chains.</p>

<p>In short, a complete <strong>iptables</strong> cleanup can be achieved running the following commands:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre># iptables -F
# iptables -X
# iptables -t nat -F
# iptables -t nat -X
# iptables -t mangle -F
# iptables -t mangle -X
# iptables -t raw -F
# iptables -t raw -X
</pre></td></tr></tbody></table></code></pre></div></div>

<p>After that cleanup, if you list current rules (<code class="highlighter-rouge">iptables -L</code>), surely you will see the default <strong>iptables</strong> setup.</p>

<h2 id="adding-rules">Adding rules</h2>

<p>Now let’s get to the most interesting part: let’s add our first rule to <strong>iptables</strong>. As an example, let’s add a rule to block access to the machine itself (<code class="highlighter-rouge">127.0.0.1</code> or <code class="highlighter-rouge">localhost</code>).</p>

<p>Before that, <strong><a href="https://linux.die.net/man/8/ping">ping</a></strong> the machine itself and make sure it works (use <strong>Ctrl + C</strong> to interrupt it):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>$ ping 127.0.0.1
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.036 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.106 ms
^C
--- 127.0.0.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1010ms
rtt min/avg/max/mdev = 0.036/0.071/0.106/0.035 ms
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Then add the rule:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -A INPUT -d 127.0.0.1 -j DROP
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Let’s examine what each part of this command does:</p>

<ul>
  <li>the <code class="highlighter-rouge">filter</code> table is being considered, as we aren’t specifying a table (as with previous commands, we could use the <code class="highlighter-rouge">-t</code> parameter to specify a table)</li>
  <li>the <code class="highlighter-rouge">-A</code> parameter tells <strong>iptables</strong> to append the rule to the end of the selected chain</li>
  <li><code class="highlighter-rouge">INPUT</code> is the chain where the rule is being added — in this case, we are interested in the packets arriving at the machine</li>
  <li>the <code class="highlighter-rouge">-d</code> parameter (it could also be written <code class="highlighter-rouge">--dst</code> or <code class="highlighter-rouge">--destination</code>) specifies the destination — in this case, we want to filter packets destined for <code class="highlighter-rouge">127.0.0.1</code> (the machine itself)</li>
  <li>the <code class="highlighter-rouge">-j</code> parameter (or <code class="highlighter-rouge">--jump</code>) indicates what to do with a packet that matches the rule (the target) — in this case, discard (<code class="highlighter-rouge">DROP</code>)</li>
</ul>

<p>Now, after adding the rule, try pinging again:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>$ ping 127.0.0.1
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
^C
--- 127.0.0.1 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1006ms
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Did you see? It didn’t work. <strong>iptables</strong> is blocking these packets based on the rule we just added.</p>

<div class="alert alert-warning" role="alert">

<p><strong>Note:</strong> the above rule has been used for didatic purposes only. Never block access to the machine itself, unless you know what you are doing, because many applications use TCP sockets to make connections.</p>

</div>

<p>That said, let’s undo the addition of the above rule before continuing:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -F
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="setting-the-default-policy-for-a-chain">Setting the default policy for a chain</h2>

<p>Between flushing tables and adding rules, I usually set the default policy for the chains. Using the <code class="highlighter-rouge">iptables -L</code> command, we saw that the default <strong>iptables</strong> setting is to allow all traffic in all chains (default policy of <code class="highlighter-rouge">ACCEPT</code>).</p>

<p>Usually, when we adopt a permissive default policy (<code class="highlighter-rouge">ACCEPT</code>) for a chain, we add restrictive rules (<code class="highlighter-rouge">DROP</code> or <code class="highlighter-rouge">REJECT</code>) to that chain, i.e. rules determine what to block and everything else is allowed.</p>

<p>Conversely, when we adopt a restrictive default policy (<code class="highlighter-rouge">DROP</code>) for a chain, we add permissive rules (<code class="highlighter-rouge">ACCEPT</code>) to that chain, i.e. rules determine what to allow and everything else is blocked.</p>

<p>For most chains, a permissive default policy (<code class="highlighter-rouge">ACCEPT</code>) is considered insecure. At least for the <code class="highlighter-rouge">INPUT</code> chain, consider using a restrictive default policy (<code class="highlighter-rouge">DROP</code>). Thus, you only need to allow services that are considered secure and don’t risk forgetting to block any unwanted accesses.</p>

<p>To set the default policy for a chain, use the <code class="highlighter-rouge">iptables -P</code> command followed by the chain name and the target you would like to be the default policy. Examples:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre># iptables -P FORWARD DROP
# iptables -P INPUT DROP
# iptables -P OUTPUT ACCEPT
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If you run the three commands above, something may stop working, e.g. your browser becomes unable to access websites. That happens because network traffic generally needs to be two-way — outgoing and incoming, request and response — to work properly. In this case, although the request is sent (the default policy for the <code class="highlighter-rouge">OUTPUT</code> chain is <code class="highlighter-rouge">ACCEPT</code>), the response is dropped (default policy for <code class="highlighter-rouge">INPUT</code> is <code class="highlighter-rouge">DROP</code>). To prevent such cases, I usually add the following rule:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is a “ready recipe” I found on the Internet to accept connections that have already been established. This rule tells <strong>iptables</strong> to allow responses to requests initiated by the machine itself.</p>

<p>Note that default policies are set for built-in (non-user-defined) chains only.</p>

<h2 id="describing-packets">Describing packets</h2>

<p>Let’s take a look at some parameters we can use to describe packets when writing rules, as well as examples of valid rules.</p>

<div class="alert alert-warning" role="alert">

<p><strong>Note:</strong> following rules are just examples, you shouldn’t simply copy and paste them to your server or desktop, adapt them according to your needs.</p>

</div>

<ul>
  <li>
    <p><strong>destination:</strong> we’ve already seen the <code class="highlighter-rouge">-d</code> (or <code class="highlighter-rouge">--dst</code>, or <code class="highlighter-rouge">--destination</code>) parameter, which lets you filter a packet by its destination, which can be:</p>

    <ul>
      <li>a host IP address (e.g. <code class="highlighter-rouge">157.240.12.35</code>);</li>
      <li>a network/subnet IP address followed by the network mask, either in common notation (e.g. <code class="highlighter-rouge">157.240.12.0/255.255.255.0</code>) or in <a href="https://doc.m0n0.ch/quickstartpc/intro-CIDR.html">CIDR</a> notation (e.g. <code class="highlighter-rouge">157.240.12.0/24</code>);</li>
      <li>a hostname (e.g. <code class="highlighter-rouge">www</code>); or</li>
      <li>a fully qualified domain name (<a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">FQDN</a>, e.g. <code class="highlighter-rouge">www.facebook.com</code>).</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -A OUTPUT -d 157.240.12.35 -j REJECT
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(it reads: all packets leaving this machine destined for <code class="highlighter-rouge">157.240.12.35</code> must be rejected — it’s one of the IP addresses assigned to <code class="highlighter-rouge">www.facebook.com</code>, but note that blocking access to Facebook is actually not that simple, this rule is just an example)</p>

<div class="alert alert-warning" role="alert">

<p><strong>Warning:</strong> even though you can use names to write rules, that is a really bad idea, prefer to use IP addresses (imagine what can happen if your DNS server goes down — or worse, if it gets hacked).</p>

</div>

<ul>
  <li><strong>source:</strong> similarly, the <code class="highlighter-rouge">-s</code> (or <code class="highlighter-rouge">--src</code>, or <code class="highlighter-rouge">--source</code>) parameter lets you filter a packet by its source, which can be described the same way as the destination.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -A INPUT -s 222.187.224.200 -j DROP
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(all packets trying to enter this machine coming from <code class="highlighter-rouge">222.187.224.200</code> must be discarded — once, this IP address was trying to attack a server I was administering, I don’t know if this address is still used for attacks)</p>

<ul>
  <li><strong>source interface:</strong> the <code class="highlighter-rouge">-i</code> (or <code class="highlighter-rouge">--in-interface</code>) parameter lets you filter a packet by the network interface via which it was received (e.g. <code class="highlighter-rouge">eth0</code>).</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -A INPUT -i lo -j ACCEPT
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(all packets received on the <a href="https://en.wikipedia.org/wiki/Loopback">loopback interface</a> — <code class="highlighter-rouge">lo</code> — must be allowed)</p>

<ul>
  <li><strong>destination interface:</strong> similarly, the <code class="highlighter-rouge">-o</code> (or <code class="highlighter-rouge">--out-interface</code>) parameter lets you filter a packet by the network interface via which it is going to be sent.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -A FORWARD -i eth0 -o eth1 -j DROP
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(discard all packets that try to pass from the <code class="highlighter-rouge">eth0</code> interface to the <code class="highlighter-rouge">eth1</code> interface)</p>

<ul>
  <li><strong>protocol:</strong> the <code class="highlighter-rouge">-p</code> (or <code class="highlighter-rouge">--protocol</code>) parameter lets you filter a packet by its protocol, which can be one of TCP, UDP or ICMP, written in uppercase or lowercase.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -A INPUT -p icmp -j ACCEPT
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(allow all ICMP packets — e.g. <strong>ping</strong>)</p>

<ul>
  <li>
    <p><strong>source port:</strong> the <code class="highlighter-rouge">--sport</code> (or <code class="highlighter-rouge">--source-port</code>) parameter lets you filter a packet by its source port, this parameter can only be used in conjunction with <code class="highlighter-rouge">-p tcp</code> or <code class="highlighter-rouge">-p udp</code>.</p>
  </li>
  <li>
    <p><strong>destination port:</strong> the <code class="highlighter-rouge">--dport</code> (or <code class="highlighter-rouge">--destination-port</code>) parameter lets you filter a packet by its destination port, this parameter can only be used in conjunction with <code class="highlighter-rouge">-p tcp</code> or <code class="highlighter-rouge">-p udp</code>.</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre># iptables -A INPUT -p tcp --dport 22 -i eth0 -j ACCEPT
# iptables -A INPUT -p udp --dport 22 -i eth0 -j ACCEPT
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(allow all incoming TCP and UDP packets received on the <code class="highlighter-rouge">eth0</code> interface destined for port 22 — which is the default port of the SSH service)</p>

<p><strong>Note:</strong> all of the above parameters can be negated by usign an exclamation sign (<code class="highlighter-rouge">!</code>) before.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre># iptables -A INPUT -p tcp --dport 22 ! -i eth0 -j DROP
# iptables -A INPUT -p udp --dport 22 ! -i eth0 -j DROP
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(discard all incoming TCP and UDP packets destined for port 22 received on an interface <strong>other than</strong> <code class="highlighter-rouge">eth0</code>)</p>

<p>Knowing these parameters, you are already able to write many rules, but <strong>iptables</strong> provides even more options. For the complete list, refer to the <strong>iptables</strong> man page:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ man iptables
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Or, if you prefer to read it using your web browser:</p>

<ul>
  <li><a href="https://linux.die.net/man/8/iptables">iptables(8) - Linux man page</a></li>
</ul>

<p>The following port list may also be useful when writing rules:</p>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers">List of TCP and UDP port numbers - Wikipédia</a></li>
</ul>

<h2 id="what-is-the-difference-between-drop-and-reject">What is the difference between DROP and REJECT?</h2>

<p>At this point you may be wondering this.</p>

<p>The <code class="highlighter-rouge">DROP</code> and <code class="highlighter-rouge">REJECT</code> targets are similar in that both block the packet (both don’t let the packet through). But the <code class="highlighter-rouge">DROP</code> target silently discards the packet, the sender does not get a response and “feels” ignored, while the <code class="highlighter-rouge">REJECT</code> target responds to the connection request with a “connection refused” error message.</p>

<p>You can see the difference between <code class="highlighter-rouge">DROP</code> and <code class="highlighter-rouge">REJECT</code> outlined in the figure at the beginning of the post.</p>

<p>Let’s test that difference. Add the following rule using the <code class="highlighter-rouge">DROP</code> target:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables -A OUTPUT -d kamarada.github.io -j DROP
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now try to access <a href="https://kamarada.github.io/">kamarada.github.io</a> using your favorite web browser (I suggest you open that link in a new tab). After a long time trying to connect, the browser reports that the site couldn’t be reached because it took too long to respond:</p>

<div class="image no-ads-here text-center mb-3" itemscope="" itemtype="http://schema.org/ImageObject">
<a href="/files/2019/11/iptables-drop-en.jpg" title="">
<img src="/files/2019/11/iptables-drop-en.jpg" alt="" class="img-fluid img-thumbnail" itemprop="contentUrl" />
</a>

</div>

<p>Delete that rule (to delete only a specific rule, you can repeat it by changing <code class="highlighter-rouge">-A</code> to <code class="highlighter-rouge">-D</code>) and add another rule, this time using the <code class="highlighter-rouge">REJECT</code> target:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre># iptables -D OUTPUT -d kamarada.github.io -j DROP
# iptables -A OUTPUT -d kamarada.github.io -j REJECT
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now refresh that tab. The browser immediately reports that the connection was <strong>refused</strong>:</p>

<div class="image no-ads-here text-center mb-3" itemscope="" itemtype="http://schema.org/ImageObject">
<a href="/files/2019/11/iptables-reject-en.jpg" title="">
<img src="/files/2019/11/iptables-reject-en.jpg" alt="" class="img-fluid img-thumbnail" itemprop="contentUrl" />
</a>

</div>

<p>Depending on your intention, it may be more interesting to use one or the other target. For instance, I would use <code class="highlighter-rouge">REJECT</code> to block websites from an office network, because a more emphatic message would be displayed for the users, but to block unwanted types of access from the outside world I would use <code class="highlighter-rouge">DROP</code>, because an eventual attacker would not receive a response and would feel like “shooting in the dark”.</p>

<h2 id="saving-and-restoring-rules">Saving and restoring rules</h2>

<p>Rules are stored in the kernel and start to be applied as soon as <strong>iptables</strong> commands are executed, but they are ephemeral, i.e. they are lost if the system is rebooted.</p>

<p>Two tools that you can use to save and restore rules are <strong><a href="https://linux.die.net/man/8/iptables-save">iptables-save</a></strong> and <strong><a href="https://linux.die.net/man/8/iptables-restore">iptables-restore</a></strong>, respectively.</p>

<p>To save the rules currently in use, run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables-save &gt; /path/to/file
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To restore rules from a previously created file, run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># iptables-restore &lt; /path/to/file
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="configuring-iptables-with-shell-script">Configuring iptables with shell script</h2>

<p>Although <strong>iptables-save</strong> and <strong>iptables-restore</strong> are convenient, the most common way to set up <strong>iptables</strong> (erase rules, set default policies, add rules) is to write a shell script. It is more readable and easier to document and maintain.</p>

<p>For example, create a script named <code class="highlighter-rouge">my-firewall.sh</code> in the <code class="highlighter-rouge">/usr/local/sbin/</code> folder using your favorite text editor (I’m going to use <strong><a href="https://www.nano-editor.org/">nano</a></strong>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># nano /usr/local/sbin/my-firewall.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Copy and paste the following content (<strong>hint:</strong> to paste into the terminal, use <strong>Ctrl + Shift + V</strong>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-ex</span>

<span class="c"># Cleanup</span>
iptables <span class="nt">-F</span>
iptables <span class="nt">-X</span>
iptables <span class="nt">-t</span> nat <span class="nt">-F</span>
iptables <span class="nt">-t</span> nat <span class="nt">-X</span>
iptables <span class="nt">-t</span> mangle <span class="nt">-F</span>
iptables <span class="nt">-t</span> mangle <span class="nt">-X</span>
iptables <span class="nt">-t</span> raw <span class="nt">-F</span>
iptables <span class="nt">-t</span> raw <span class="nt">-X</span>

<span class="c"># Default policy: block all incoming connections</span>
iptables <span class="nt">-P</span> FORWARD DROP
iptables <span class="nt">-P</span> INPUT DROP
iptables <span class="nt">-P</span> OUTPUT ACCEPT

<span class="c"># Allow previously established connections</span>
iptables <span class="nt">-A</span> INPUT <span class="nt">-m</span> state <span class="nt">--state</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT

<span class="c"># Allow loopback connections</span>
iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> lo <span class="nt">-j</span> ACCEPT

<span class="c"># SSH (port 22/TCP,UDP)</span>
iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--dport</span> 22 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> udp <span class="nt">--dport</span> 22 <span class="nt">-j</span> ACCEPT

<span class="c"># HTTP (port 80/TCP)</span>
iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--dport</span> 80 <span class="nt">-j</span> ACCEPT
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="alert alert-warning" role="alert">

<p>This script is a very simple template designed for a web server. Remember to adapt it to your needs.</p>

</div>

<p>Change the file permissions so that only the root user is allowed to run the script:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># chmod 744 /usr/local/sbin/my-firewall.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>That’s it! Now, when you need to set up <strong>iptables</strong>, just run the script:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># /usr/local/sbin/my-firewall.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>When you need to change the firewall rules, edit the script and run it again.</p>

<h2 id="starting-iptables-at-boot">Starting iptables at boot</h2>

<p>For our firewall to be perfect, just one thing is missing: rules must be set up at boot time, together with the operating system, networking and services.</p>

<p>On <strong><a href="https://freedesktop.org/wiki/Software/systemd/">systemd</a></strong> distributions, such as openSUSE and Linux Kamarada, the best way to run a script such as <code class="highlighter-rouge">my-firewall.sh</code> at boot time is to create a service.</p>

<p>For example, create a systemd service called <code class="highlighter-rouge">my-firewall.service</code> in the <code class="highlighter-rouge">/etc/systemd/system/</code> folder using your favorite text editor:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># nano /etc/systemd/system/my-firewall.service
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Copy and paste the following content:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>[Unit]
After=network.target

[Service]
ExecStart=/usr/local/sbin/my-firewall.sh

[Install]
WantedBy=default.target
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Adjust the file permissions:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre># chmod 664 /etc/systemd/system/my-firewall.service
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Install and enable the service so that it starts at next boot:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre># systemctl daemon-reload
# systemctl enable my-firewall
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If you want to test your service before rebooting, run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre># systemctl start my-firewall
# iptables -L
</pre></td></tr></tbody></table></code></pre></div></div>

<p>That’s it! The next time you reboot your system, <strong>systemd</strong> will start the service that runs the script that configures <strong>iptables</strong>.</p>

<h2 id="references">References</h2>

<p>I hope this text was helpful. If you have read it all, now you have enough knowledge to deploy <strong>iptables</strong> on your servers. If you want to know more, you can read these:</p>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Firewall_(computing)">Firewall (computing) - Wikipedia</a></li>
  <li><a href="https://linux.die.net/man/8/iptables">iptables(8) - Linux man page</a></li>
  <li><a href="https://www.digitalocean.com/community/tutorials/iptables-essentials-common-firewall-rules-and-commands">Iptables Essentials: Common Firewall Rules and Commands - DigitalOcean</a></li>
  <li><a href="https://www.linode.com/docs/security/firewalls/control-network-traffic-with-iptables/">Control Network Traffic with iptables - Linode</a></li>
  <li><a href="https://www.suse.com/c/basic-iptables-tutorial/">Basic iptables Tutorial - SUSE Communities</a></li>
  <li><a href="https://www.cyberciti.biz/tips/howto-block-ipaddress-with-iptables-firewall.html">Linux Iptables block incoming access to selected or specific ip address - nixCraft</a></li>
  <li><a href="https://linuxconfig.org/how-to-automatically-execute-shell-script-at-startup-boot-on-systemd-linux">How to automatically execute shell script at startup boot on systemd Linux - LinuxConfig.org</a></li>
</ul>


        </div>

        
            <!-- AddThis Sharing Buttons -->
            <div class="gap"></div>
            <h2>
                
                    Did you like it? What about sharing?
                
            </h2>
            <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
                <a class="addthis_button_facebook"></a>
                <a class="addthis_button_twitter" data-via="LinuxKamaradaWW"></a>
                <a class="addthis_button_google_plusone_share"></a>
                <a class="addthis_button_email"></a>
                <a class="addthis_button_favorites"></a>
                <a class="addthis addthis_button_print"></a>
                <a class="addthis_button_pdfonline"></a>
                <a class="addthis_button_compact"></a>
                <a class="addthis_counter addthis_bubble_style"></a>
            </div>
            <!-- AddThis Sharing Buttons End -->
        

        
            
                <!-- Disqus -->
                <div class="gap"></div>
                <h2>
                    
                        Comments
                    
                </h2>
                <div id="disqus_thread"></div>
                <script>
                    var disqus_config = function () {
                        
                            this.language = "en";
                        
                        this.page.url = 'https://kamarada.github.io/en/2019/11/24/protect-yourself-with-the-iptables-firewall/';
                    };

                    (function() {
                        var d = document, s = d.createElement('script');

                        s.src = '//kamaradaww.disqus.com/embed.js';

                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                    })();
                </script>
                <noscript>
                    <p>Please <a href="http://www.enable-javascript.com/" target="_blank">enable JavaScript</a> to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus</a>.</p>
                </noscript>
                <!-- Disqus End -->
            
        
    </article>
</div><!-- .blog-post -->

                    </div>
                    <div class="col-sm-4">
                        <div class="card mb-3" id="about">
    <div class="card-header">
      <h3>
          <a name="about"></a>
          
              About
          
      </h3>
    </div>
    <div class="card-body" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="Linux Kamarada" />
        <meta itemprop="url" content="https://kamarada.github.io" />
        <p class='text-center' itemprop='logo' itemscope itemtype='http://schema.org/ImageObject'>
            <a href='https://kamarada.github.io/assets/img/TuxKamarada.png' itemprop='url'>
                <img src='https://kamarada.github.io/assets/img/TuxKamarada.png' class='img-fluid'>
            </a>
            <!--<meta itemprop="width" content=""/>--><!-- TODO Image width -->
            <!--<meta itemprop="height" content=""/>--><!-- TODO Image height -->
        </p>
        <p class="text" itemprop="description">
            
                The Linux Kamarada Project aims to spread and promote Linux as a robust, secure, versatile and easy to use operating system, suitable for everyday use be at home, at work or on the server. The project focuses mainly on distribution and documentation.

            
        </p>
        
            <!-- AddThis Follow Buttons -->
            <div class="addthis_toolbox addthis_32x32_style addthis_default_style addthis_follow_buttons text-center">
                
                    <a href="https://facebook.com/LinuxKamarada" class="addthis_button_facebook_follow" addthis:userid="LinuxKamarada" itemprop="sameAs"></a>
                
                
                    <a href="https://twitter.com/LinuxKamaradaWW" class="addthis_button_twitter_follow" addthis:userid="LinuxKamaradaWW" itemprop="sameAs"></a>
                
                
                    <a href="https://instagram.com/Kamarada_Linux" class="addthis_button_instagram_follow" addthis:userid="Kamarada_Linux" itemprop="sameAs"></a>
                
                
                
                
                
                
                    <a href="https://github.com/LinuxKamaradaNews" class="addthis_button_telegram_follow" addthis:userid="LinuxKamaradaNews" itemprop="sameAs"></a>
                
                
                    <a href="https://github.com/kamarada" class="addthis_button_github_follow" addthis:userid="kamarada" itemprop="sameAs"></a>
                
                <a href="https://kamarada.github.io/en/feed.xml" class="addthis_button_rss_follow"></a>
            </div>
            <!-- AddThis Follow Buttons End -->
        
    </div><!-- .card-body -->
</div><!-- .card -->


    <div class="card mb-3">
        <div class="card-body">
            
    <!-- Google AdSense -->
    <ins class="adsbygoogle" id="sidebar_ad_unit"
        style="display:block"
        data-ad-client="ca-pub-5193467168351289"
        data-ad-slot="7329324255"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    <!-- End Google AdSense -->


        </div><!-- .col-xs-12 -->
    </div><!-- .row -->



    <div class="card mb-3 d-none d-lg-block">
        <div class="card-header">
            <h3>
                Facebook
            </h3>
        </div>
        <div class="card-body">
            <div id="facebook-page-plugin-wrapper">
                <!-- Facebook Page Plugin -->
                <div class="fb-page" data-href="https://www.facebook.com/LinuxKamarada/" data-tabs="timeline" data-width="" data-height="450" data-small-header="false" data-adapt-container-width="true" data-hide-cover="false" data-show-facepile="true"><blockquote cite="https://www.facebook.com/LinuxKamarada/" class="fb-xfbml-parse-ignore"><a href="https://www.facebook.com/LinuxKamarada/">Linux Kamarada</a></blockquote></div>
            </div><!-- #facebook-page-plugin-wrapper -->
        </div><!-- .card-body -->
    </div><!-- .card -->



    
        <div class="card mb-3 d-none d-lg-block">
            <div class="card-header">
                <h3>
                    Twitter
                </h3>
            </div>
            <div class="card-body">
                <!-- Twitter Embedded Timeline -->
                <a class="twitter-timeline" data-height="450" data-theme="light" data-link-color="#4caf50" href="https://twitter.com/LinuxKamaradaWW?ref_src=twsrc%5Etfw">Tweets by LinuxKamaradaWW</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            </div><!-- .card-body -->
        </div><!-- .card -->
    


<div class="card mb-3">
    <div class="card-header">
        <h3>
            <a name="author"></a>
            
                Author
            
        </h3>
    </div>
    <div class="card-body" itemprop="author" itemscope itemtype="http://schema.org/Person">
        
            <p class="text-center">
                <a href='https://secure.gravatar.com/avatar/5415f4267b44aa9f51b6f89ac4d1656b' title='Antônio Vinícius'>
                    <img src='https://secure.gravatar.com/avatar/5415f4267b44aa9f51b6f89ac4d1656b' alt='Antônio Vinícius' class='img-fluid img-thumbnail rounded-circle'>
                </a>
            </p>
        
        
            <p class="lead text-center" itemprop="name">
                
                    Antônio Vinícius
                
            </p>
        
        <ul class="contact-list list-unstyled">
            
                <li><a href="http://www.vinyanalista.com.br" itemprop="url"><i class="fas fa-globe"></i> http://www.vinyanalista.com.br</a></li>
            
        </ul>
    </div><!-- .card-body -->
</div><!-- .card -->

                    </div>
                </div>
            </div>

            <footer class="footer">
    <div class="container">
        Copyright &copy; 2020 <a href='#author'>Antônio Vinícius</a>. All rights reserved. Based on <a href='https://github.com/vinyanalista/material-jekyll-plus'>Material site template for Jekyll PLUS</a>.
    </div>
</footer>

<meta itemprop="description" content="We haven’t talked about servers for a while… Today we are going to talk about security thinking on servers first, but on desktops too, either at home or at work. The Internet has made it much easier to access, send and share information. But together with the pros, come the cons: besides convenience, the Internet...">


    <div itemprop="image" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://kamarada.github.io/files/2019/11/iptables.jpg"/>
        <!--<meta itemprop="width" content=""/>--><!-- TODO Image width -->
        <!--<meta itemprop="height" content=""/>--><!-- TODO Image height -->
    </div>



    <meta itemprop="inLanguage" content="en"/>



    
        <!-- Disqus -->
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES * * */
            
                var disqus_config = function () {
                    this.language = "en";
                };
            
            var disqus_shortname = 'kamaradaww';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var s = document.createElement('script'); s.async = true;
                s.type = 'text/javascript';
                s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
            }());
        </script>
        <!-- Disqus End -->
    



    <!-- Google AdSense -->
    
        
    <!-- Google AdSense -->
    <ins class="adsbygoogle" id="content_ad_unit_2"
        style="display:block"
        data-ad-client="ca-pub-5193467168351289"
        data-ad-slot="4375857858"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    <!-- End Google AdSense -->


    

    <script type="text/javascript">
        adsbygoogle = window.adsbygoogle || [];

        $(document).ready(function(){
            
                var $ad = $('#content_ad_unit_2');
                var $posts = $('.blog-post');
                if (($posts.length > 1) || ($('.blog-archive-title').length > 0)) {
                    // Post listing
                    var post;
                    if ($posts.length > 2) {
                        post = random_number(2, $posts.length);
                    } else {
                        post = 2;
                    }
                    $posts.eq(post - 1).find('.blog-post-content .row').after($ad);
                } else {
                    // Page or post
                    var $paragraphs = $('.blog-post-content p').filter(function() {
                        return ($(this).closest('.no-ads-here').length == 0);
                    });
                    if ($paragraphs.length > 0) {
                        var paragraph;
                        if ($paragraphs.length > 1) {
                            paragraph = random_number(1, $paragraphs.length);
                        } else {
                            paragraph = 1;
                        }
                        $paragraphs.eq(paragraph - 1).after($ad);
                    } else {
                        $ad.remove();
                    }
                }
            
            $('.adsbygoogle').each(function(index, element){
                adsbygoogle.push({});
            });
        });
    </script>
    <!-- Google AdSense End -->



            
        </main>
    </div><!-- .bmd-layout-container -->

    <div class="modal fade" id="language-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"><i class="fas fa-globe-americas" aria-hidden="true"></i> Translations</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <div class="list-group list-group-flush bmd-list-group-sm">
                    
                    
                        <a href="#" class="list-group-item list-group-item-action disabled">English</a>
                        
                        
                            <a class="list-group-item list-group-item-action translation-en" href="https://kamarada.github.io/en/2019/11/24/protect-yourself-with-the-iptables-firewall/">This page in English</a>
                        
                        <a class="list-group-item list-group-item-action" href="https://kamarada.github.io/en/">English home page</a>
                    
                        <a href="#" class="list-group-item list-group-item-action disabled">Português</a>
                        
                        
                            <a class="list-group-item list-group-item-action translation-pt" href="https://kamarada.github.io/pt/2019/11/18/proteja-se-com-o-firewall-iptables/">Esta página em Português</a>
                        
                        <a class="list-group-item list-group-item-action" href="https://kamarada.github.io/pt/">Página inicial em Português</a>
                    
                    <a href="#" class="list-group-item list-group-item-action disabled">Other languages (by Google Translate)</a>
                    <a class="list-group-item list-group-item-action" href="http://translate.google.com/translate?js=n&sl=en&u=https://kamarada.github.io/en/2019/11/24/protect-yourself-with-the-iptables-firewall/">Translate this page</a>
                </div>

            </div><!--.modal-body-->
        </div><!--.modal-content-->
    </div><!--.modal-dialog-->
</div><!--#language-modal-->

</body>
</html>
